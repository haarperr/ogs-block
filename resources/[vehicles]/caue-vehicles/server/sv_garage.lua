--[[

    Garages

]]

local garagesConfig = {
    ["Pillbox Hill"] = {
        ["type"] = "car",
        ["pos"] = vector4(-309.2, -954.49, 30.4, 68.94),
        ["distance"] = 500,
        ["spaces"] = {
            vector4(-297.73, -990.12, 30.4, 341.02),
            vector4(-301.39, -989.32, 30.4, 340.46),
            vector4(-304.71, -987.45, 30.4, 341.2),
            vector4(-308.35, -986.77, 30.4, 340.45),
            vector4(-311.59, -985.13, 30.4, 338.57),
            vector4(-315.36, -984.38, 30.4, 340.78),
            vector4(-318.76, -983.13, 30.4, 340.11),
            vector4(-322.02, -981.56, 30.4, 339.8),
            vector4(-325.54, -980.28, 30.4, 340.0),
            vector4(-329.2, -979.26, 30.4, 340.78),
            vector4(-332.63, -977.91, 30.4, 340.58),
            vector4(-336.19, -976.79, 30.4, 341.13),
            vector4(-339.59, -975.44, 30.4, 341.04),
            vector4(-343.08, -974.14, 30.4, 339.54),
            vector4(-313.71, -964.69, 30.4, 71.3),
            vector4(-312.37, -961.24, 30.4, 70.61),
            vector4(-311.08, -957.74, 30.4, 70.64),
            vector4(-309.2, -954.49, 30.4, 68.94),
            vector4(-308.62, -950.89, 30.4, 71.13),
            vector4(-306.8, -947.53, 30.4, 72.34),
            vector4(-305.77, -943.99, 30.4, 69.86),
            vector4(-304.34, -940.5, 30.4, 70.7),
            vector4(-303.27, -937.02, 30.4, 71.13),
            vector4(-301.98, -933.55, 30.4, 70.15),
            vector4(-326.34, -956.49, 30.4, 250.66),
            vector4(-325.16, -952.79, 30.4, 250.77),
            vector4(-323.98, -949.39, 30.4, 250.53),
            vector4(-322.72, -945.91, 30.4, 250.24),
            vector4(-321.38, -942.36, 30.4, 250.69),
            vector4(-320.12, -939.0, 30.4, 250.94),
            vector4(-319.01, -935.48, 30.4, 251.4),
            vector4(-317.69, -931.96, 30.4, 250.05),
            vector4(-316.46, -928.48, 30.4, 250.44),
            vector4(-337.7, -952.2, 30.4, 70.85),
            vector4(-336.41, -948.83, 30.4, 69.8),
            vector4(-335.17, -945.32, 30.4, 69.41),
            vector4(-333.93, -941.75, 30.4, 70.47),
            vector4(-332.59, -938.43, 30.4, 69.99),
            vector4(-331.52, -934.73, 30.4, 71.67),
            vector4(-329.98, -931.34, 30.4, 69.88),
            vector4(-328.8, -927.92, 30.4, 71.03),
            vector4(-327.54, -924.46, 30.4, 70.75),
            vector4(-345.03, -932.18, 30.4, 250.52),
            vector4(-343.7, -928.76, 30.4, 249.15),
            vector4(-342.34, -925.27, 30.4, 249.82),
            vector4(-341.09, -921.75, 30.4, 251.56),
            vector4(-340.83, -902.69, 30.4, 168.05),
            vector4(-337.21, -903.45, 30.4, 167.94),
            vector4(-333.57, -904.13, 30.4, 168.29),
            vector4(-329.99, -904.93, 30.4, 169.89),
            vector4(-326.29, -905.64, 30.4, 168.64),
            vector4(-322.57, -906.43, 30.4, 168.41),
            vector4(-318.94, -907.01, 30.4, 168.91),
            vector4(-315.33, -907.7, 30.4, 168.42),
            vector4(-311.73, -908.81, 30.4, 168.46),
            vector4(-308.05, -909.5, 30.4, 167.97),
            vector4(-285.63, -921.94, 30.4, 71.06),
            vector4(-284.2, -918.38, 30.4, 70.55),
            vector4(-282.71, -915.0, 30.4, 70.75),
            vector4(-281.53, -911.56, 30.4, 69.54),
            vector4(-280.48, -907.93, 30.4, 70.1),
            vector4(-279.18, -904.51, 30.4, 71.11),
            vector4(-285.71, -887.77, 30.4, 169.92),
            vector4(-289.49, -887.37, 30.4, 168.18),
            vector4(-293.05, -886.65, 30.4, 167.55),
            vector4(-296.58, -885.95, 30.4, 167.75),
            vector4(-300.19, -885.14, 30.4, 166.91),
            vector4(-303.82, -884.29, 30.4, 169.44),
            vector4(-307.45, -883.54, 30.4, 168.85),
            vector4(-311.19, -882.65, 30.4, 169.6),
            vector4(-314.75, -881.88, 30.4, 167.01),
            vector4(-318.31, -881.19, 30.4, 168.65),
            vector4(-322.01, -880.41, 30.4, 167.6),
            vector4(-325.64, -879.73, 30.4, 168.98),
            vector4(-329.41, -879.04, 30.4, 168.4),
            vector4(-332.95, -878.18, 30.4, 168.32),
            vector4(-336.38, -877.13, 30.4, 168.74),
            vector4(-340.06, -876.29, 30.39, 168.54),
            vector4(-343.66, -875.73, 30.4, 167.35),
            vector4(-298.41, -899.36, 30.4, 347.37),
            vector4(-302.04, -898.71, 30.4, 347.96),
            vector4(-305.76, -898.05, 30.4, 348.49),
            vector4(-309.33, -897.08, 30.4, 348.38),
            vector4(-312.98, -896.56, 30.4, 348.49),
            vector4(-316.66, -895.84, 30.4, 348.13),
            vector4(-320.18, -894.86, 30.4, 348.17),
            vector4(-323.88, -894.14, 30.4, 349.88),
            vector4(-327.49, -893.21, 30.4, 348.14),
            vector4(-331.1, -892.43, 30.4, 347.67),
            vector4(-334.76, -891.67, 30.39, 347.06),
            vector4(-338.42, -890.92, 30.39, 347.48),
            vector4(-360.25, -889.48, 30.4, 270.85),
            vector4(-360.36, -893.18, 30.4, 270.5),
            vector4(-360.54, -896.86, 30.4, 271.16),
            vector4(-360.37, -900.55, 30.4, 270.71),
            vector4(-360.28, -904.19, 30.4, 270.35),
            vector4(-360.35, -907.92, 30.4, 270.56),
            vector4(-360.08, -911.66, 30.4, 271.24),
            vector4(-360.37, -915.39, 30.4, 269.73),
            vector4(-360.37, -918.93, 30.4, 269.36),
            vector4(-360.25, -922.77, 30.4, 271.32),
            vector4(-360.23, -926.39, 30.4, 270.83),
            vector4(-360.18, -930.06, 30.4, 269.56),
            vector4(-360.18, -933.83, 30.4, 271.47),
            vector4(-360.25, -937.55, 30.4, 271.23),
            vector4(-360.05, -941.3, 30.4, 270.97),
            vector4(-360.01, -944.9, 30.4, 272.22),
            vector4(-360.1, -948.63, 30.4, 269.92),
            vector4(-360.36, -952.24, 30.4, 269.81),
            vector4(-360.22, -956.07, 30.4, 271.31),
        },
    },
    ["Paleto"] = {
        ["type"] = "car",
        ["pos"] = vector4(-85.3, 6346.27, 31.5, 53.93),
        ["distance"] = 250,
        ["spaces"] = {
            vector4(-80.15, 6333.82, 31.09, 225.37),
            vector4(-77.39, 6336.43, 31.09, 225.47),
            vector4(-75.01, 6339.18, 31.09, 223.73),
            vector4(-71.9, 6341.73, 31.09, 225.98),
            vector4(-77.29, 6347.14, 31.09, 45.78),
            vector4(-80.05, 6344.52, 31.09, 45.29),
            vector4(-82.83, 6341.58, 31.09, 44.4),
            vector4(-85.62, 6339.08, 31.09, 45.8),
            vector4(-100.89, 6339.32, 31.09, 223.99),
            vector4(-98.11, 6341.76, 31.09, 224.47),
            vector4(-95.62, 6344.5, 31.09, 225.82),
            vector4(-92.9, 6347.03, 31.09, 226.16),
            vector4(-90.29, 6349.71, 31.09, 225.42),
            vector4(-87.51, 6352.57, 31.09, 225.92),
            vector4(-84.79, 6355.37, 31.09, 224.8),
            vector4(-81.78, 6358.15, 31.09, 225.64),
            vector4(-72.5, 6358.35, 31.09, 135.27),
            vector4(-69.44, 6355.63, 31.09, 134.75),
            vector4(-66.68, 6352.67, 31.09, 134.43),
            vector4(-63.99, 6350.27, 31.09, 133.66),
            vector4(-61.22, 6347.39, 31.09, 132.86),
            vector4(-58.69, 6344.73, 31.09, 134.96),
        },
    },
    ["Grand Senora"] = {
        ["type"] = "car",
        ["pos"] = vector4(1121.64, 2658.18, 38.0, 180.3),
        ["distance"] = 250,
        ["spaces"] = {
            vector4(1135.42, 2647.79, 37.6, 0.22),
            vector4(1131.55, 2647.82, 37.6, 359.34),
            vector4(1127.61, 2647.78, 37.6, 0.15),
            vector4(1124.12, 2647.93, 37.6, 0.29),
            vector4(1120.49, 2647.74, 37.6, 0.35),
            vector4(1116.75, 2647.51, 37.6, 359.11),
            vector4(1111.63, 2654.27, 37.6, 270.36),
            vector4(1111.85, 2657.83, 37.59, 269.73),
            vector4(1105.46, 2663.49, 37.57, 0.21),
            vector4(1101.66, 2663.45, 37.57, 0.94),
            vector4(1098.12, 2663.14, 37.57, 0.53),
        },
    },
    ["Alta"] = {
        ["type"] = "car",
        ["pos"] = vector4(281.52, -334.44, 44.92, 50.39),
        ["distance"] = 250,
        ["spaces"] = {
            vector4(293.1, -349.77, 44.54, 70.42),
            vector4(293.79, -346.2, 44.52, 70.62),
            vector4(295.09, -343.03, 44.52, 70.4),
            vector4(296.4, -339.87, 44.52, 70.28),
            vector4(297.66, -336.58, 44.52, 69.23),
            vector4(298.81, -333.38, 44.52, 71.04),
            vector4(299.82, -330.05, 44.52, 70.55),
            vector4(289.78, -326.11, 44.52, 250.14),
            vector4(288.45, -329.39, 44.52, 249.71),
            vector4(287.32, -332.58, 44.52, 250.97),
            vector4(286.12, -335.86, 44.52, 250.55),
            vector4(284.97, -339.1, 44.52, 249.89),
            vector4(283.7, -342.52, 44.51, 249.84),
            vector4(276.81, -340.04, 44.52, 69.72),
            vector4(278.01, -336.69, 44.52, 69.87),
            vector4(279.22, -333.46, 44.52, 70.05),
            vector4(280.17, -330.2, 44.52, 70.35),
            vector4(281.57, -326.89, 44.52, 69.86),
            vector4(282.82, -323.64, 44.52, 69.91),
            vector4(271.35, -319.35, 44.52, 250.5),
            vector4(270.26, -322.62, 44.52, 250.61),
            vector4(269.15, -325.89, 44.52, 250.86),
            vector4(267.91, -329.07, 44.52, 250.69),
            vector4(266.49, -332.19, 44.52, 251.41),
        },
    },
    ["Vepucci Beach"] = {
        ["type"] = "car",
        ["pos"] = vector4(-1190.95, -1484.11, 3.98, 158.25),
        ["distance"] = 150,
        ["spaces"] = {
            vector4(-1191.09, -1504.08, 3.97, 304.5),
            vector4(-1196.68, -1497.08, 3.96, 305.39),
            vector4(-1197.92, -1494.07, 3.97, 304.19),
            vector4(-1200.07, -1491.32, 3.97, 303.27),
            vector4(-1204.79, -1484.64, 3.97, 305.94),
            vector4(-1194.17, -1480.16, 3.98, 125.95),
            vector4(-1192.22, -1483.1, 3.98, 125.47),
            vector4(-1190.69, -1485.95, 3.98, 123.33),
            vector4(-1188.71, -1488.33, 3.98, 124.98),
            vector4(-1186.8, -1490.86, 3.98, 125.13),
            vector4(-1185.12, -1493.47, 3.98, 124.89),
            vector4(-1183.33, -1496.01, 3.98, 125.31),
            vector4(-1176.78, -1491.43, 3.98, 304.63),
            vector4(-1178.59, -1488.94, 3.98, 306.38),
            vector4(-1180.27, -1486.47, 3.98, 306.48),
            vector4(-1182.18, -1483.8, 3.98, 304.18),
            vector4(-1184.81, -1479.86, 3.98, 304.0),
            vector4(-1187.53, -1476.02, 3.98, 304.07),
            vector4(-1189.66, -1472.99, 3.98, 305.14),
            vector4(-1191.56, -1469.97, 3.98, 303.6),
        },
    },
    ["MRPD"] = {
        ["type"] = "police",
        ["jobGarage"] = true,
        ["pos"] = vector4(437.31, -996.93, 25.3, 90.1),
        ["distance"] = 150,
        ["spaces"] = {
            vector4(445.74, -996.94, 25.3, 269.16),
            vector4(445.57, -994.23, 25.3, 269.26),
            vector4(445.8, -991.49, 25.3, 268.82),
            vector4(445.73, -988.86, 25.3, 269.45),
            vector4(445.73, -986.11, 25.3, 269.32),
            vector4(437.27, -986.16, 25.3, 89.2),
            vector4(437.28, -988.87, 25.3, 91.25),
            vector4(437.41, -991.59, 25.3, 89.96),
            vector4(437.3, -994.28, 25.3, 90.01),
            vector4(437.31, -996.93, 25.3, 90.1),
            vector4(425.71, -997.08, 25.3, 270.01),
            vector4(425.74, -994.41, 25.3, 269.55),
            vector4(425.76, -991.65, 25.3, 270.83),
            vector4(425.82, -988.97, 25.3, 269.8),
            vector4(425.75, -984.27, 25.3, 270.67),
            vector4(425.78, -981.54, 25.3, 269.55),
            vector4(425.88, -978.81, 25.3, 270.18),
            vector4(425.77, -976.13, 25.3, 270.51),
        },
    },
    ["Hospital"] = {
        ["type"] = "ems",
        ["jobGarage"] = true,
        ["pos"] = vector4(316.52, -578.24, 28.4, 250.64),
        ["distance"] = 250,
        ["spaces"] = {
            vector4(332.97, -590.6, 28.4, 339.91),
            vector4(329.62, -589.53, 28.4, 341.87),
            vector4(326.34, -588.32, 28.4, 340.95),
            vector4(323.04, -587.06, 28.4, 341.23),
            vector4(319.58, -585.71, 28.4, 340.55),
            vector4(316.52, -578.24, 28.4, 250.64),
            vector4(318.12, -573.93, 28.4, 248.37),
            vector4(319.71, -569.74, 28.4, 249.57),
            vector4(321.05, -565.23, 28.4, 248.56),
        },
    },
    ["Canals"] = {
        ["type"] = "boat",
        ["pos"] = vector4(-857.58, -1327.78, -0.47, 107.76),
        ["distance"] = 150,
        ["spaces"] = {
            vector4(-857.58, -1327.78, -0.47, 107.76),
            vector4(-855.26, -1336.42, -0.47, 108.41),
            vector4(-851.03, -1344.45, 0.41, 109.07),
            vector4(-848.12, -1352.86, 0.41, 108.52),
            vector4(-845.14, -1361.77, 0.41, 107.34),
            vector4(-842.01, -1371.8, 0.41, 108.99),
            vector4(-839.15, -1380.12, 0.41, 108.83),
            vector4(-836.15, -1388.92, 0.41, 108.28),
            vector4(-833.57, -1397.34, 0.41, 107.18),
            vector4(-830.86, -1406.13, 0.41, 107.18),
        },
    },
    ["SandyPD"] = {
        ["type"] = "state_police",
        ["jobGarage"] = true,
        ["pos"] = vector4(1850.5, 3674.34, 33.58, 210.21),
        ["distance"] = 50,
        ["spaces"] = {
            vector4(1853.82, 3676.05, 33.57, 210.95),
            vector4(1850.5, 3674.34, 33.58, 210.21),
            vector4(1847.34, 3672.27, 33.52, 210.45),
        },
    },
    ["PaletoPD"] = {
        ["type"] = "sheriff",
        ["jobGarage"] = true,
        ["pos"] = vector4(-475.91, 6031.72, 31.16, 226.43),
        ["distance"] = 100,
        ["spaces"] = {
            vector4(-482.52, 6024.65, 31.16, 223.31),
            vector4(-479.27, 6028.09, 31.16, 223.99),
            vector4(-475.91, 6031.72, 31.16, 226.43),
            vector4(-472.13, 6035.14, 31.16, 223.62),
            vector4(-468.54, 6038.59, 31.16, 223.95),
        },
    },
    ["ParkRangersPD"] = {
        ["type"] = "park_ranger",
        ["jobGarage"] = true,
        ["pos"] = vector4(374.35, 797.26, 187.21, 178.92),
        ["distance"] = 50,
        ["spaces"] = {
            vector4(374.35, 797.26, 187.21, 178.92),
        },
    },
}

--[[

    Exports

]]

exports("getGarage", function(pGarage, pVar)
    return garagesConfig[pGarage][pVar]
end)

--[[

    RPCs

]]

RPC.register("caue-vehicles:requestGarages", function(src)
    return garagesConfig
end)

RPC.register("caue-vehicles:getGarage", function(src, garage)
    local cid = exports["caue-base"]:getChar(src, "id")
    if not cid then return {} end

    local type = garagesConfig[garage]["type"]

    local vehicles = exports.ghmattimysql:executeSync([[
        SELECT v2.id, v2.plate, v2.model, v3.body_damage, v3.engine_damage, v3.fuel
        FROM vehicles_garage v1
        INNER JOIN vehicles v2 ON v2.id = v1.vid AND v2.cid = ? AND v2.type = ?
        INNER JOIN vehicles_metadata v3 ON v3.vid = v1.vid
        WHERE garage = ? AND state = "In"
    ]],
    { cid, type, garage })

    return vehicles
end)

RPC.register("caue-vehicles:canStoreVehicle", function(src, garage, vid)
    local typeGarage = garagesConfig[garage]["type"]

    local typeVehicle = exports.ghmattimysql:scalarSync([[
        SELECT type
        FROM vehicles
        WHERE id = ?
    ]],
    { vid })

    if not typeVehicle then
        TriggerClientEvent("DoLongHudText", src, "Error?", 2)
        return false
    end

    if typeVehicle ~= typeGarage then
        TriggerClientEvent("DoLongHudText", src, "You cant store this vehicle here", 2)
        return false
    end

    return true
end)

--[[

    Threads

]]

Citizen.CreateThread(function()
    exports.ghmattimysql:execute([[
        UPDATE vehicles_garage
        SET state = "In"
        WHERE state = "Out"
    ]])
end)